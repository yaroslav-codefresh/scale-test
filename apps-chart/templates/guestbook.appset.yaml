apiVersion: argoproj.io/v1alpha1
kind: ApplicationSet
metadata:
  name: {{ .Values.spec.product }}-{{ .Values.spec.service }}-appset
  finalizers:
    - resources-finalizer.argocd.argoproj.io/foreground
spec:
  generators:
    - list:
        elements:
          - index: 1
          - index: 2
          - index: 3
  template:
    metadata:
      name: {{ .Values.spec.product }}-{{ .Values.spec.service }}-appset-app-{{index}}
      finalizers:
        - resources-finalizer.argocd.argoproj.io/foreground
    project: default
    source:
      path: helm-guestbook
      repoURL: https://github.com/yaroslav-codefresh/argocd-example-apps.git
      targetRevision: HEAD
    destination:
      name: in-cluster
      namespace: {{ .Values.spec.product }}-{{ .Values.spec.service }}
    syncPolicy:
      automated:
        prune: false
        selfHeal: true
        allowEmpty: false
      syncOptions:
        - PrunePropagationPolicy=foreground
        - Replace=false
        - PruneLast=false
        - Validate=true
        - CreateNamespace=true
        - ApplyOutOfSyncOnly=false
        - ServerSideApply=true
        - RespectIgnoreDifferences=false
